Scripts
-------

Every unit contains a script which control the level flow e.g. switches, doors, cinematics etc, these scripts are PE files exporting functions called by the game.

Scripts can be found extracting the unit DRM file using https://github.com/Gh0stBlade/cdcEngineTools and looking for a .gnc file with MS-DOS stub (This program cannot be run in DOS mode), next remove the .SECT header and drop the file in your favorite disassembler e.g. IDA Pro, Ghidra.

Exports
~~~~~~~

The following symbols are usually exported:

* EventMain
* EventRelocate
* CallTrigger
* IsTriggerActive
* EventDebug

The last `EventDebug` is not a function but instead array of debug strings.
[source,cpp]
----
// from pu1
char* EventDebug[8] = { "doorsopened", "pusha", 
                        "pushb", "introcine", 
                        "tutorial_start", "doorreveala", 
                        "level_title_start", "sherpasilent" };
                        // [...]
----

The `EventMain` function will be called from the game loop every loop which is where most of the logic is.
[source,cpp]
----
int EventMain(GameTracker* a1, StreamUnit* a2, int a3)
{
	(a3 + 1512)("02_CN_Hotel", 0); // StartBlockingCine
}
----

**a3** in this function is a pointer to a table where functions and variables are stored for the scripts.

Example
~~~~~~~

It is possible to hook the `EventMain` function and implement your own logic, an example of this in the video below.

++++
<iframe width="560" height="315" src="https://www.youtube.com/embed/-9BbhLukBac" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
++++

In this video `EventMain` is hooked to the function below
[source,cpp]
----
int HookedEventMain(int gametracker, int unit, int a3)
{
	auto instanceFind = 
		((int(__cdecl*)(int)) *(DWORD*)(a3 + 252));
	auto instanceQuery = 
		((int(__cdecl*)(int, int)) *(DWORD*)(a3 + 236));
	auto instancePost = 
		((void(__cdecl*)(DWORD, DWORD, int)) *(DWORD*)(a3 + 240));
	auto instanceKill = 
		((void(__cdecl*)(DWORD, int)) *(DWORD*)(a3 + 352));

	// call instanceFind to get an instance of level object by a fixed 'intro' id
	auto lever = instanceFind(3367);
	auto door = instanceFind(3349);

	// query the lever until it returns 1
	if (lever && instanceQuery(lever, 233) == 1)
	{
		// post to the door to open
		instancePost(door, 8388753, 0);
	}
}
----

Another example below, this turns the door security light to green after the player have shot the target behind the painting.

[source,cpp]
----
auto target = instanceFind(4568); // sw_ma_shootable_switch
auto light = instanceFind(4603); // ae_ma_security_light

if (target && instanceQuery(target, 245) == 1)
{
	instancePost(light, 8388752, 1);
}
----


Function table
~~~~~~~~~~~~~~

The third parameter in `EventMain` will always be a pointer to a table of functions and other data which the game scripts will use. Below a table of known offsets.

[cols="10%,30%,60%a"]
|===
|Offset |Name |Description

|224
|Version
|`4103` on both PC and PS2, scripts return "wrong event version for pu1\n" if it doesn't match

|236
|InstanceQuery(Instance* instance, int unk1)
|
Get a value from an instance e.g. to query a lever
[source,cpp]
----
if(instanceQuery(lever, 233) == 1)
{
	printf("open the door!\n");
}
----

|240
|void InstancePost(Instance* instance, int unk1, int data)
|Post data to an instance

|252
|Instance* InstanceFind(int intro)
|Find an instance by unique 'intro' id

|280
|int unk(Instance* a1, Instance*, a2, int a3)
|This is something related to anim data, in unit scripts this data is passed to InstanceSetEventAnimPlaying

|464
|void nullsub(char*)
|nullsub, this is called by unit scripts to log debug messages. https://www.youtube.com/watch?v=k1FIa8Pel3E[this video] previews a playthrough with debug prints in St. Francis Folly.

|716
|void InstanceSetEventAnimPlaying(Instance* instance, int a2)
|Plays the anim data on an instance

|1016
|void SwitchChapter(char* chapter)
|Switches to a chapter by name (chapter0, chapter1, chapter2, chapter3, chapter4)

|1308
|char IsPs2()
|Hardcoded to return 0 on PC

|1512
|int StartBlockingCine(char* cine, bool loop)
|Starts a cinematic, example from cn2
[source,cpp]
----
(a3 + 1512))("02_CN_Hotel", 0); // StartBlockingCine
----

|===

PS2 version
~~~~~~~~~~~

On the PS2 versions scripts are still in PE format but MIPS instructions instead of x86.

The event version is the same as on PC `4103`

[source,asm]
----
loc_10002038:
lw      $t6, 0xE0($s2)
li      $at, 0x1007 ; 4103
beq     $t6, $at, loc_10002064 ; continue
nop
----

If you are not familiar with MIPS `beg` checks `if ($t6 == $at) go to loc_10002064` where loc_10002064 continues
